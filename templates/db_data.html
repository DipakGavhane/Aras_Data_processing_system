<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Students Marks Table</title>
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.min.css">
    <!-- DataTables Buttons CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.7.1/css/buttons.dataTables.min.css">

    <style>
      table {
        border-collapse: collapse;
        width: 100%;
        table-layout: fixed; /* Enforces the column widths */
      }
      th, td {
        padding: 8px;
        text-align: center;
        border: 1px solid #ddd;
        word-wrap: break-word; /* Prevents overflow */
      }
      th {
        background-color: #f2f2f2;
      }
      .micro_text {
        font-size: x-small;
      }
      .small_text {
        font-size: small;
      }
      /* Custom separator style for the right border between subject groups */
      .subject-separator {
        border-right: 2px solid #000 !important;
      }
      .name-column {
           height: 40px;                /* Fixed height */
           overflow: hidden;            /* Hide text that exceeds the fixed height */
           text-overflow: ellipsis;     /* Optionally show an ellipsis for truncated text */
            white-space: nowrap;         /* Prevent text from wrapping to multiple lines */
      }
    </style>
  </head>
  <body>
    <h1>Students Marks Table</h1>
        <button id="exportPDF" style="background-color: blue; color: white; padding: 10px; border: none; cursor: pointer; margin-bottom: 10px;">
     Download as PDF
    </button>
    <table id="marksTable">
      <!-- Define column widths using colgroup -->
      <colgroup>
        <col style="width: 50px;">  <!-- Sr. NO.-->
        <col style="width: 100px;"> <!-- Name -->
        <col style="width: 110px;"> <!-- Roll Number -->
        <col style="width: 90px;">  <!-- College Code -->
        <col style="width: 100px;"> <!-- Semester -->
        {% for subject in subject_list %}
          <col style="width: 62px;"> <!-- Internal Max -->
          <col style="width: 62px;"> <!-- Internal Score -->
          <col style="width: 62px;"> <!-- Theory Max -->
          <col style="width: 62px;"> <!-- Theory Score -->
        {% endfor %}
        <col style="width: 85px;"> <!-- Result -->
        <col style="width: 80px;"> <!-- SGPA -->
      </colgroup>
      <thead style="font-size: medium;">
        <!-- First header row: Subject names -->
        <tr>
          <th rowspan="3" class="small_text">Sr. No.</th>
          <th rowspan="3">Name</th>
          <th rowspan="3">Roll Number</th>
          <th rowspan="3">College Code</th>
          <th rowspan="3">Semester</th>
          {% for subject in subject_list %}
            <th colspan="4" {% if not loop.last %}class="subject-separator"{% endif %}>
              {{ subject }}
            </th>
          {% endfor %}
          <th rowspan="3">Result</th>
          <th rowspan="3">SGPA</th>
        </tr>
        <!-- Second header row: Internal and Theory labels -->
        <tr>
          {% for subject in subject_list %}
            <th colspan="2" class="small_text">Internal</th>
            <th colspan="2" class="small_text {% if not loop.last %}subject-separator{% endif %}">Theory</th>
          {% endfor %}
        </tr>
        <!-- Third header row: Max and Score for each type -->
        <tr>
          {% for subject in subject_list %}
            <th class="micro_text">Max</th>
            <th class="micro_text">Score</th>
            <th class="micro_text">Max</th>
            <th class="micro_text {% if not loop.last %}subject-separator{% endif %}">Score</th>
          {% endfor %}
        </tr>
      </thead>
      <tbody style="font-size: medium;">
        {% for student in students %}
          <tr>
            <td>{{ loop.index }}.</td>
<!--            <td class="small_text">{{ student.name }}</td>-->
<!--            <td class="small_text name-column">{{ student.name }}</td>-->
            <td class="small_text name-column" title="{{ student.name }}">
                {% if student.name %}
                  {% set name_words = student.name.split(' ') %}
                  {{ name_words[:3] | join(' ') }}
                {% else %}
                  No name provided
                {% endif %}
            </td>


            <td>{{ student.roll_number }}</td>
            {% if student.college_code != None %}
                <td>{{ student.college_code[3:6] }}...</td>
            {% else %}
                <td>{{ student.college_code }}...</td>
            {% endif %}

            <td class="small_text">{{ student.semester }}</td>
            {% for subject in subject_list %}
              {% if subject in student.subjects %}
                <td>{{ student.subjects[subject].internal_max }}</td>
                <td>{{ student.subjects[subject].internal_obtain }}</td>
                <td>{{ student.subjects[subject].theory_max }}</td>
                <td {% if not loop.last %}class="subject-separator"{% endif %}>
                  {{ student.subjects[subject].theory_obtain }}
                </td>
              {% else %}
                <td></td>
                <td></td>
                <td></td>
                <td {% if not loop.last %}class="subject-separator"{% endif %}></td>
              {% endif %}

            {% endfor %}
            <td>{{ student.result }}</td>
            <td>{{ student.sgpa }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <button id="deleteAllBtn" style="background-color: red; color: white; padding: 10px; border: none; cursor: pointer; margin-bottom: 10px;">
     Delete All Records
    </button>
    <!-- jQuery and DataTables JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>


    <script>
      document.getElementById('exportPDF').addEventListener('click', function () {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape');
      // Use the autoTable plugin to generate the PDF from your table element
      doc.autoTable({ html: '#marksTable' });
      doc.save('Students_Marks_Table.pdf');
      });


      $(document).ready(function() {
  $('#marksTable').DataTable({
       paging: true,
       searching: true,
       ordering: true,
  });

  $('#deleteAllBtn').click(function() {
    if (confirm('Are you sure you want to delete all records? This action cannot be undone!')) {
      $.ajax({
        url: '/delete_all',
        type: 'POST',
        success: function(response) {
          alert(response.message);
          location.reload();
        },
        error: function(xhr, status, error) {
          alert('Error deleting records: ' + error);
        }
      });
    }
  });
});

    </script>
  </body>
</html>
